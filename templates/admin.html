<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Proctoring System</title>

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flowbite CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
    }
  </style>
</head>

<body class="bg-gray-50">

  <!-- Sidebar Toggle (Mobile) -->
  <button data-drawer-target="default-sidebar" data-drawer-toggle="default-sidebar" aria-controls="default-sidebar"
    type="button"
    class="inline-flex items-center p-2 mt-2 ms-3 text-sm text-gray-500 rounded-lg sm:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200">
    <span class="sr-only">Open sidebar</span>
    <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <path clip-rule="evenodd" fill-rule="evenodd"
        d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z">
      </path>
    </svg>
  </button>

  <!-- Sidebar -->
  <aside id="default-sidebar"
    class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0"
    aria-label="Sidebar">
    <div class="h-full px-3 py-4 overflow-y-auto bg-white border-r border-gray-200">
      <a href="admin.html" class="flex items-center ps-2.5 mb-8 mt-2">
        <div class="bg-gray-900 text-white p-1.5 rounded-lg mr-3">
          <i data-lucide="shield-alert" class="w-6 h-6"></i>
        </div>
        <span class="self-center text-xl font-bold whitespace-nowrap text-gray-900">Admin Panel</span>
      </a>
      <ul class="space-y-2 font-medium">
        <li>
          <a href="admin.html" class="flex items-center p-2 text-white bg-blue-600 rounded-lg group">
            <i data-lucide="layout-dashboard" class="w-5 h-5 text-white"></i>
            <span class="ms-3">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="manage-users.html" class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
            <i data-lucide="users" class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
            <span class="ms-3">Manage Users</span>
          </a>
        </li>
        <li>
          <a href="manage-exams.html" class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
            <i data-lucide="file-text"
              class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
            <span class="ms-3">Manage Exams</span>
          </a>
        </li>
        <li>
          <a href="admin-feedback.html" class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
            <i data-lucide="message-square"
              class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
            <span class="ms-3">Feedbacks</span>
          </a>
        </li>

        <li class="pt-4 mt-4 space-y-2 border-t border-gray-200">
          <a href="#" id="logoutBtn"
            class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group cursor-pointer">
            <i data-lucide="log-out" class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
            <span class="ms-3">Sign Out</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="p-4 sm:ml-64">
    <div class="p-4 mt-10 sm:mt-0">

      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">System Overview</h1>
        <p class="text-gray-500 mt-1">Welcome back, Admin.</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Pending Requests -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-medium text-gray-500">Pending Requests</h3>
            <div class="p-2 bg-yellow-50 text-yellow-600 rounded-lg">
              <i data-lucide="user-plus" class="w-5 h-5"></i>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="totalPending">0</p>
        </div>

        <!-- Professors -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-medium text-gray-500">Professors</h3>
            <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
              <i data-lucide="graduation-cap" class="w-5 h-5"></i>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="totalProfessors">0</p>
        </div>

        <!-- Students -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-medium text-gray-500">Students</h3>
            <div class="p-2 bg-green-50 text-green-600 rounded-lg">
              <i data-lucide="book-open" class="w-5 h-5"></i>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="totalStudents">0</p>
        </div>

        <!-- Exams -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-medium text-gray-500">Total Exams</h3>
            <div class="p-2 bg-orange-50 text-orange-600 rounded-lg">
              <i data-lucide="file-check" class="w-5 h-5"></i>
            </div>
          </div>
          <p class="text-3xl font-bold text-gray-900" id="totalExams">0</p>
        </div>
      </div>

      <!-- Pending Approvals Table -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
          <h3 class="text-lg font-bold text-gray-900">Pending Teacher Approvals</h3>
        </div>
        <div class="relative overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3">Applicant</th>
                <th scope="col" class="px-6 py-3">Email</th>
                <th scope="col" class="px-6 py-3">Requested On</th>
                <th scope="col" class="px-6 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="pendingTableBody">
              <tr>
                <td colspan="4" class="px-6 py-4 text-center">Loading pending requests...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Latest Approved Lists -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Latest Professors -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900 text-purple-700">Latest Approved Professors</h3>
          </div>
          <div class="relative overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">Username</th>
                  <th scope="col" class="px-6 py-3">Email</th>
                </tr>
              </thead>
              <tbody id="latestProfessorsBody">
                <tr>
                  <td colspan="2" class="px-6 py-4 text-center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Latest Students -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900 text-green-700">Latest Approved Students</h3>
          </div>
          <div class="relative overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">Username</th>
                  <th scope="col" class="px-6 py-3">Email</th>
                </tr>
              </thead>
              <tbody id="latestStudentsBody">
                <tr>
                  <td colspan="2" class="px-6 py-4 text-center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { app, auth, db } from '/static/js/firebase-config.js';
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { collection, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Elements
    const totalPendingEl = document.getElementById('totalPending');
    const totalProfessorsEl = document.getElementById('totalProfessors');
    const totalStudentsEl = document.getElementById('totalStudents');
    const totalExamsEl = document.getElementById('totalExams');
    const pendingTableBody = document.getElementById('pendingTableBody');
    const latestProfessorsBody = document.getElementById('latestProfessorsBody');
    const latestStudentsBody = document.getElementById('latestStudentsBody');

    // Auth Check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      fetchData();
    });

    // Fetch Data
    async function fetchData() {
      try {
        // Fetch All Users to count stats
        const usersSnapshot = await getDocs(collection(db, "users"));
        let profCount = 0;
        let studCount = 0;
        let pendingUsers = [];
        let approvedProfs = [];
        let approvedStuds = [];

        usersSnapshot.forEach(doc => {
          const data = doc.data();
          const role = data.role || "";
          const userData = { id: doc.id, ...data };

          if (role === 'teacher') {
            if (data.approved === true) {
              profCount++;
              approvedProfs.push(userData);
            } else if (data.approved === false || data.approved === undefined) {
              pendingUsers.push(userData);
            }
          } else if (role === 'student') {
            studCount++;
            approvedStuds.push(userData);
          }
        });

        // Fetch Exams
        const examsSnapshot = await getDocs(collection(db, "exams"));
        const examCount = examsSnapshot.size;

        // Update Stats
        totalPendingEl.textContent = pendingUsers.length;
        totalProfessorsEl.textContent = profCount;
        totalStudentsEl.textContent = studCount;
        totalExamsEl.textContent = examCount;

        // Render Pending Table
        renderPendingTable(pendingUsers);

        // Render Latest Tables
        renderLatestList(approvedProfs, latestProfessorsBody, 'purple');
        renderLatestList(approvedStuds, latestStudentsBody, 'green');

      } catch (error) {
        console.error("Error fetching data:", error);
        alert("Error loading dashboard data.");
      }
    }

    // Render Pending Table
    function renderPendingTable(users) {
      pendingTableBody.innerHTML = "";
      if (users.length === 0) {
        pendingTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No pending approvals.</td></tr>`;
        return;
      }

      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = "bg-white border-b hover:bg-gray-50";

        const initials = (user.name || user.username || "?").charAt(0).toUpperCase();
        const dateStr = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : "N/A";

        tr.innerHTML = `
                    <th scope="row" class="flex items-center px-6 py-4 text-gray-900 whitespace-nowrap">
                         <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 font-bold mr-3">
                            ${initials}
                        </div>
                        <div class="ps-3">
                            <div class="text-base font-semibold">${user.name || user.username || "Unknown"}</div>
                            <div class="font-normal text-gray-500 text-xs">Role: Teacher</div>
                        </div>
                    </th>
                    <td class="px-6 py-4">
                        ${user.email || "No Email"}
                    </td>
                    <td class="px-6 py-4">
                        ${dateStr}
                    </td>
                    <td class="px-6 py-4 text-right">
                         <button onclick="window.approveUser('${user.id}')" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-3 py-1.5 mr-2 mb-1">Approve</button>
                         <button onclick="window.rejectUser('${user.id}')" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-3 py-1.5 mb-1">Reject</button>
                    </td>
                `;
        pendingTableBody.appendChild(tr);
      });
    }

    // Render Latest List Helper
    function renderLatestList(users, tableBody, color) {
      tableBody.innerHTML = "";

      // Sort by createdAt desc if available, else standard order
      users.sort((a, b) => {
        const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
        const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
        return dateB - dateA;
      });

      const topUsers = users.slice(0, 5); // Take top 5

      if (topUsers.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center">No users found.</td></tr>`;
        return;
      }

      topUsers.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = "bg-white border-b hover:bg-gray-50";
        const initials = (user.name || user.username || "?").charAt(0).toUpperCase();

        // Dynamic Colors
        const bgClass = color === 'purple' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600';

        tr.innerHTML = `
                    <th scope="row" class="flex items-center px-6 py-3 text-gray-900 whitespace-nowrap">
                         <div class="w-8 h-8 rounded-full ${bgClass} flex items-center justify-center font-bold mr-3 text-xs">
                            ${initials}
                        </div>
                        <span class="font-medium">${user.username || user.name || "Unknown"}</span>
                    </th>
                    <td class="px-6 py-3 text-gray-500">
                        ${user.email || "No Email"}
                    </td>
                `;
        tableBody.appendChild(tr);
      });
    }

    // Action: Approve
    window.approveUser = async (userId) => {
      if (!confirm("Approve this professor request?")) return;
      try {
        await updateDoc(doc(db, "users", userId), { approved: true });
        alert("✅ User approved!");
        fetchData();
      } catch (e) {
        console.error("Error approving:", e);
        alert("Failed to approve.");
      }
    };

    // Action: Reject
    window.rejectUser = async (userId) => {
      if (!confirm("Reject and delete this request?")) return;
      try {
        await deleteDoc(doc(db, "users", userId));
        alert("❌ Request rejected and deleted.");
        fetchData();
      } catch (e) {
        console.error("Error rejecting:", e);
        alert("Failed to reject.");
      }
    };

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      signOut(auth).then(() => {
        window.location.href = "index.html";
      }).catch((error) => {
        alert("Error signing out.");
      });
    });

    // Mobile Toggle Helper
    const sidebarToggle = document.querySelector('[data-drawer-toggle="default-sidebar"]');
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', () => {
        const sidebar = document.getElementById('default-sidebar');
        sidebar.classList.toggle('-translate-x-full');
      });
    }

    lucide.createIcons();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>

</html>