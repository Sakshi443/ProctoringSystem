<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Make Exam</title>
  <link rel="stylesheet" href="../css/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <style>
    .optionInput.selected {
      border: 2px solid #22c55e;
      background-color: #f0fdf4;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-100">
  <nav class="fixed top-0 z-50 w-full bg-white border-gray-50  dark:bg-gray-50 dark:border-gray-600">
    <div class="px-3 py-3 lg:px-5 lg:pl-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center justify-start rtl:justify-end">
          <a href="#" class="flex items-center space-x-3 rtl:space-x-reverse">
            <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-black">Proctor</span>
          </a>
        </div>
        <div class="flex items-center">
          <div class="flex items-center ms-3">
            <button type="button"
              class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
              aria-expanded="false" data-dropdown-toggle="dropdown-user">
              <span class="sr-only">Open user menu</span>
              <a href="#"
                class="inline-flex items-center justify-center p-4 border-b-2 border-transparent rounded-t-lg text-gray-500 border-gray-500 bg-gray-100 hover:bg-gray-100  hover:text-gray-800 hover:border-gray-800 group">
                <svg class="w-4 h-4 me-2 text-gray-500 group-hover:text-gray-800" aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z" />
                </svg>
                Profile
              </a>

              <!-- <img class="w-8 h-8 rounded-full"
                                src="https://flowbite.com/docs/images/people/profile-picture-5.jpg" alt="user photo"> -->
            </button>
            <div id="dropdown-user"
              class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded shadow dark:bg-gray-700 dark:divide-gray-600">
              <div class="px-4 py-3">
                <p id="currentUserName" class="text-sm text-gray-500 dark:text-white">Professor</p>
                <p id="currentUserEmail" class="text-sm font-medium text-gray-500 truncate dark:text-gray-300">
                  professor@example.com</p>
              </div>
              <ul>
                <li>
                  <a href="/templates/index.html"
                    class="block px-4 py-2 text-sm text-gray-100 hover:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-300 dark:hover:text-gray-800"
                    onclick="logout()">Sign out</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <aside id="logo-sidebar"
    class="fixed top-0 left-0 z-40 w-64 h-screen pt-20 transition-transform -translate-x-full bg-gray-300 border-r border-gray-200 sm:translate-x-0 dark:bg-gray-400 dark:border-gray-500"
    aria-label="Sidebar">
    <div class="h-full px-3 pb-4 overflow-y-auto bg-black dark:bg-gray-200">
      <ul class="space-y-2 font-medium">
        <li>
          <a href="./professorDashboard.html"
            class="flex items-center p-2 text-gray-900 rounded-lg dark:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-400 group">
            <span class="flex-1 ms-3 whitespace-nowrap">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="./make-exam.html"
            class="flex items-center p-2 text-gray-900 rounded-lg dark:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-400 group">
            <span class="flex-1 ms-3 whitespace-nowrap">Make paper</span>
          </a>
        </li>
        <li>
          <a href="./admin-panel.html"
            class="flex items-center p-2 text-gray-900 rounded-lg dark:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-400 group">
            <span class="flex-1 ms-3 whitespace-nowrap">Admin panel</span>
          </a>
        </li>
        <li>
          <a href="/templates/index.html" onclick="logout()"
            class="flex items-center p-2 text-gray-900 rounded-lg dark:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-400 group">
            <svg
              class="shrink-0 w-5 h-5 text-gray-900 transition duration-75 dark:text-gray-800 group-hover:text-gray-400 dark:group-hover:text-white"
              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 16">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M1 8h11m0 0L8 4m4 4-4 4m4-11h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-3" />
            </svg>
            <span class="flex-1 ms-3 whitespace-nowrap">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>
  <!-- end of Navbar -->
  <div class="p-6 sm:ml-64">
    <div class="p-4 border-2 border-gray-200 rounded-lg mt-14 bg-white shadow">
      <h2 class="text-xl font-bold mb-4">üìù Create New Exam</h2>

      <div id="examForm">
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 font-medium">Test Name</label>
            <input type="text" id="testName" class="w-full border rounded px-3 py-2" placeholder="e.g., Sample Test" />
          </div>
          <div>
            <label class="block mb-2 font-medium">Test Duration (minutes)</label>
            <input type="number" id="testDuration" class="w-full border rounded px-3 py-2" min="1" />
          </div>
          <div>
            <label class="block mb-2 font-medium">Start Date & Time</label>
            <input type="datetime-local" id="startDateTime" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block mb-2 font-medium">End Date & Time</label>
            <input type="datetime-local" id="endDateTime" class="w-full border rounded px-3 py-2" />
          </div>
          <div class="md:col-span-2">
            <label class="block mb-2 font-medium">Test Description</label>
            <textarea id="testDescription" class="w-full border rounded px-3 py-2" rows="3"
              placeholder="Enter exam details here..."></textarea>
          </div>
        </div>

        <button id="openModalBtn" class="bg-blue-500 text-white px-4 py-2 rounded">‚ûï Add Question</button>

        <div class="mt-4">
          <table class="min-w-full border text-sm" id="questionTable">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1">Question</th>
                <th class="border px-2 py-1">Marks</th>
                <th class="border px-2 py-1">Negative</th>
                <th class="border px-2 py-1">Options</th>
                <th class="border px-2 py-1">Correct</th>
                <th class="border px-2 py-1">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p class="mt-2 text-sm text-gray-600">Total Questions: <span id="questionCount" class="font-semibold">0</span>
        </p>

        <button id="saveExamBtn" class="bg-green-600 text-white px-6 py-2 rounded mt-4">Save Exam</button>
      </div>
    </div>
  </div>

  <div id="questionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Add New Question</h3>
        <button id="closeModalBtn" class="text-gray-600 hover:text-black">&times;</button>
      </div>
      <div class="space-y-4">
        <div><label class="block">Question Type</label>
          <select id="qType" class="w-full border rounded px-3 py-2">
            <option value="mcq_single">MCQ (Single)</option>
            <option value="mcq_multiple">MSQ (Multiple)</option>
          </select>
        </div>
        <div><label class="block">Question Text</label>
          <textarea id="qText" class="w-full border rounded px-3 py-2" rows="3"></textarea>
        </div>
        <div><label class="block">Marks</label>
          <input type="number" id="qMarks" class="w-full border rounded px-3 py-2" />
        </div>
        <div><label class="block">Negative Marking</label>
          <select id="qNegative" class="w-full border rounded px-3 py-2">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div>
          <label class="block mb-1">Options (Click to select correct)</label>
          <div id="optionInputs" class="grid grid-cols-2 gap-2">
            <input type="text" id="qOpt1" data-opt-index="1"
              class="optionInput w-full border rounded px-3 py-2 cursor-pointer" placeholder="Option 1" />
            <input type="text" id="qOpt2" data-opt-index="2"
              class="optionInput w-full border rounded px-3 py-2 cursor-pointer" placeholder="Option 2" />
            <input type="text" id="qOpt3" data-opt-index="3"
              class="optionInput w-full border rounded px-3 py-2 cursor-pointer" placeholder="Option 3" />
            <input type="text" id="qOpt4" data-opt-index="4"
              class="optionInput w-full border rounded px-3 py-2 cursor-pointer" placeholder="Option 4" />
          </div>
        </div>
      </div>
      <div class="flex justify-end mt-6">
        <button id="saveQuestionBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Save Question</button>
      </div>
    </div>
  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAg-Qc46CzCYdN_JGayHuR7xYxlsryUpZc",
      authDomain: "proctored-system.firebaseapp.com",
      projectId: "proctored-system",
      storageBucket: "proctored-system.appspot.com",   // ‚úÖ Fixed URL
      messagingSenderId: "512898908874",
      appId: "1:512898908874:web:23584b6cad04eb9e0c2a33",
      measurementId: "G-3SL8C6C8RD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const questionTableBody = document.querySelector('#questionTable tbody');
    const questionCountSpan = document.getElementById('questionCount');

    const updateQuestionCount = () => {
      questionCountSpan.innerText = questionTableBody.children.length;
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "../../index.html";
      else {
        document.getElementById('currentUserName').textContent = user.displayName || "Professor";
        document.getElementById('currentUserEmail').textContent = user.email || "No email";
      }
    });

    window.logout = async () => {
      await signOut(auth);
      localStorage.clear();
      window.location.href = "../../index.html";
    };

    document.getElementById('openModalBtn').addEventListener('click', () => {
      document.getElementById('questionModal').classList.remove('hidden');
      document.querySelectorAll('.optionInput').forEach(el => el.classList.remove('selected'));
      document.getElementById('qText').value = '';
      document.getElementById('qMarks').value = '';
      ['qOpt1', 'qOpt2', 'qOpt3', 'qOpt4'].forEach(id => document.getElementById(id).value = '');
    });

    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('questionModal').classList.add('hidden');
    });

    document.querySelectorAll('.optionInput').forEach(input => {
      input.addEventListener('click', () => {
        const type = document.getElementById('qType').value;
        if (type === 'mcq_single') {
          document.querySelectorAll('.optionInput').forEach(i => i.classList.remove('selected'));
        }
        input.classList.toggle('selected');
      });
    });

    document.getElementById('saveQuestionBtn').addEventListener('click', () => {
      const qText = document.getElementById('qText').value.trim();
      const qMarks = parseFloat(document.getElementById('qMarks').value);
      const qNegative = document.getElementById('qNegative').value;
      const options = ['qOpt1', 'qOpt2', 'qOpt3', 'qOpt4'].map(id => document.getElementById(id).value.trim());
      const correct = Array.from(document.querySelectorAll('.optionInput.selected')).map(opt => opt.dataset.optIndex);

      if (!qText || isNaN(qMarks) || options.some(o => !o) || correct.length === 0) {
        alert('‚ùå Please fill out the question, marks, all options, and select at least one correct answer.');
        return;
      }

      const row = document.createElement('tr');
      row.innerHTML = `
      <td class="border px-2 py-1">${qText}</td>
      <td class="border px-2 py-1">${qMarks}</td>
      <td class="border px-2 py-1">${qNegative}</td>
      <td class="border px-2 py-1">${options.join(', ')}</td>
      <td class="border px-2 py-1">${correct.join(',')}</td>
      <td class="border px-2 py-1 text-blue-600 cursor-pointer delete-row">Delete</td>
    `;
      questionTableBody.appendChild(row);
      updateQuestionCount();
      document.getElementById('questionModal').classList.add('hidden');
    });

    questionTableBody.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-row')) {
        e.target.closest('tr').remove();
        updateQuestionCount();
      }
    });

    document.getElementById('saveExamBtn').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return alert("You're not logged in!");

      const testName = document.getElementById('testName').value.trim();
      const duration = parseFloat(document.getElementById('testDuration').value);
      const startDateTime = document.getElementById('startDateTime').value;
      const endDateTime = document.getElementById('endDateTime').value;
      const description = document.getElementById('testDescription').value.trim();

      if (!testName || isNaN(duration) || duration <= 0 || !startDateTime || !endDateTime || questionTableBody.children.length === 0) {
        alert('‚ùå Please complete all exam details and add at least one question.');
        return;
      }

      const questions = [];
      document.querySelectorAll("#questionTable tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        questions.push({
          questionText: tds[0].innerText,
          marks: parseInt(tds[1].innerText),
          negativeMarking: tds[2].innerText === "yes",
          options: tds[3].innerText.split(",").map(opt => opt.trim()),
          correct: tds[4].innerText.split(",").map(opt => parseInt(opt.trim()))
        });
      });

      try {
        await addDoc(collection(db, "exams"), {
          testName,
          duration,
          startDateTime,
          endDateTime,
          description,
          questions,
          createdBy: user.uid,
          createdAt: serverTimestamp()
        });
        alert("‚úÖ Exam saved successfully!");
        window.location.reload();
      } catch (err) {
        console.error('‚ùå Error saving exam:', err);
        alert("‚ùå Failed to save exam. Please try again.");
      }
    });  

  </script>

</body>

</html>
