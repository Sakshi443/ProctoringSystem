<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Professor</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flowbite CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            /* gray-50 */
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- Sidebar Toggle (Mobile) -->
    <button data-drawer-target="default-sidebar" data-drawer-toggle="default-sidebar" aria-controls="default-sidebar"
        type="button"
        class="inline-flex items-center p-2 mt-2 ms-3 text-sm text-gray-500 rounded-lg sm:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200">
        <span class="sr-only">Open sidebar</span>
        <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg">
            <path clip-rule="evenodd" fill-rule="evenodd"
                d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z">
            </path>
        </svg>
    </button>

    <!-- Sidebar -->
    <aside id="default-sidebar"
        class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0"
        aria-label="Sidebar">
        <div class="h-full px-3 py-4 overflow-y-auto bg-white border-r border-gray-200">
            <a href="#" class="flex items-center ps-2.5 mb-8 mt-2">
                <div class="bg-gray-900 text-white p-1.5 rounded-lg mr-3">
                    <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                </div>
                <span class="self-center text-xl font-bold whitespace-nowrap text-gray-900">Proctor</span>
            </a>
            <ul class="space-y-2 font-medium">
                <li>
                    <a href="professorDashboard.html"
                        class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
                        <i data-lucide="layout-dashboard"
                            class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
                        <span class="ms-3">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="make-exam.html"
                        class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
                        <i data-lucide="plus-circle"
                            class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
                        <span class="ms-3">Create Exam</span>
                    </a>
                </li>
                <li>
                    <a href="manage-exams.html"
                        class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
                        <i data-lucide="file-text"
                            class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
                        <span class="ms-3">My Exams</span>
                    </a>
                </li>
                <li>
                    <a href="admin-panel.html" class="flex items-center p-2 text-gray-900 rounded-lg bg-gray-100 group">
                        <i data-lucide="settings"
                            class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
                        <span class="ms-3">Admin Panel</span>
                    </a>
                </li>

                <li class="pt-4 mt-4 space-y-2 border-t border-gray-200">
                    <a href="profile.html" class="flex items-center p-2 text-gray-900 rounded-lg bg-gray-100 group">
                        <i data-lucide="user"
                            class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
                        <span class="ms-3">Profile</span>
                    </a>
                    <a href="#" id="logoutBtn"
                        class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group cursor-pointer">
                        <i data-lucide="log-out"
                            class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900"></i>
                        <span class="ms-3">Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="p-4 sm:ml-64">
        <div class="p-4 mt-10 sm:mt-0">

            <!-- Header -->
            <div class="mb-8">
                <nav class="flex mb-4" aria-label="Breadcrumb">
                    <ol class="inline-flex items-center space-x-1 md:space-x-3">
                        <li class="inline-flex items-center">
                            <a href="professorDashboard.html"
                                class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                                <i data-lucide="home" class="w-4 h-4 me-2"></i>
                                Home
                            </a>
                        </li>
                        <li aria-current="page">
                            <div class="flex items-center">
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 mx-1"></i>
                                <span class="ms-1 text-sm font-medium text-gray-500 md:ms-2">Admin Panel</span>
                            </div>
                        </li>
                    </ol>
                </nav>
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Results & Violations</h1>
                        <p class="text-gray-500 mt-1">Review student performance and manage flagged incidents.</p>
                    </div>
                </div>
            </div>

            <!-- Exam Selector -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                <div class="flex flex-row items-center gap-4">
                    <label for="examSelect" class="text-sm font-semibold text-gray-700 whitespace-nowrap">Select
                        Exam:</label>
                    <select id="examSelect"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-64 p-2.5">
                        <option value="">Loading exams...</option>
                    </select>
                    <button id="loadExamDetailsBtn"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 flex items-center justify-center">
                        <i data-lucide="search" class="w-4 h-4 mr-2"></i> Load Data
                    </button>
                </div>
            </div>

            <!-- Results Section (Hidden by default) -->
            <div id="examDetails" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-900">Student Results</h2>
                    </div>

                    <div class="overflow-x-auto">
                        <div id="studentViolationTable" class="w-full">
                            <!-- Table inserted by JS -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" tabindex="-1" aria-hidden="true"
        class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="relative w-full max-w-4xl max-h-full">
            <!-- Modal Content -->
            <div class="relative bg-white rounded-lg shadow">
                <div class="flex items-start justify-between p-4 border-b rounded-t">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900" id="modalStatusTitle">User Status</h3>
                        <div id="modalStudentInfo" class="text-sm text-gray-500 mt-1"></div>
                    </div>
                    <button type="button" id="closeModalBtn"
                        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="p-6 space-y-6">
                    <h4 class="font-semibold text-gray-900 mb-2">Recorded Violations</h4>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Violation Type</th>
                                    <th class="px-6 py-3">Time</th>
                                    <th class="px-6 py-3">Description</th>
                                </tr>
                            </thead>
                            <tbody id="violationDetailsTable">
                                <!-- Data -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex items-center justify-end p-6 space-x-2 border-t border-gray-200 rounded-b bg-gray-50">
                    <button id="approveBtn" type="button"
                        class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center">
                        <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> Approve
                    </button>
                    <button id="denyBtn" type="button"
                        class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center">
                        <i data-lucide="ban" class="w-4 h-4 mr-2"></i> Deny
                    </button>
                    <button id="closeModalBtnFooter" type="button"
                        class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase Logic -->
    <script type="module">
        import { app, auth, db } from '/static/js/firebase-config.js';
        import { collection, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // State
        let currentUserUID = null;
        let currentExamId = "";
        let currentViolations = [];
        let submissionsMap = {};

        // DOM Elements
        const examSelect = document.getElementById("examSelect");
        const loadBtn = document.getElementById("loadExamDetailsBtn");
        const examDetailsSection = document.getElementById("examDetails");
        const tableContainer = document.getElementById("studentViolationTable");

        const studentModal = document.getElementById("studentModal");
        const modalTitle = document.getElementById("modalStatusTitle");
        const modalInfo = document.getElementById("modalStudentInfo");
        const modalTable = document.getElementById("violationDetailsTable");
        const approveBtn = document.getElementById("approveBtn");
        const denyBtn = document.getElementById("denyBtn");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const closeModalBtnFooter = document.getElementById("closeModalBtnFooter");


        // Auth
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                location.href = "../../index.html";
                return;
            }
            currentUserUID = user.uid;
            await populateExamDropdown();
        });

        async function populateExamDropdown() {
            try {
                const examsQuery = query(collection(db, "exams"), where("createdBy", "==", currentUserUID));
                const examsSnap = await getDocs(examsQuery);

                examSelect.innerHTML = `<option value="">-- Choose an Exam --</option>`;
                if (examsSnap.empty) {
                    examSelect.innerHTML += `<option value="" disabled>No exams created yet</option>`;
                }
                examsSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    const option = document.createElement("option");
                    option.value = docSnap.id;
                    option.textContent = data.testName || docSnap.id;
                    examSelect.appendChild(option);
                });
            } catch (e) {
                console.error("Error loading exams:", e);
                examSelect.innerHTML = `<option value="">Error loading exams</option>`;
            }
        }

        // Load Data
        loadBtn.addEventListener("click", async () => {
            const examId = examSelect.value;
            if (!examId) return alert("Please select an exam.");

            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Loading...';
            lucide.createIcons();

            currentExamId = examId;
            currentViolations = [];
            submissionsMap = {};

            try {
                const violationsSnap = await getDocs(collection(db, `exams/${examId}/violations`));
                const scoreSnap = await getDocs(collection(db, `exams/${examId}/submissions`));

                const studentMap = {};

                // Process Violations
                violationsSnap.forEach(doc => {
                    const v = doc.data();
                    const email = v.studentEmail;
                    currentViolations.push({ ...v, id: doc.id });

                    if (!studentMap[email]) studentMap[email] = { name: v.studentName || "Unknown", email, violations: {}, totalViolations: 0, score: "-", status: "pending" };

                    const type = v.event || v.type || "UNKNOWN";
                    studentMap[email].violations[type] = (studentMap[email].violations[type] || 0) + 1;
                    studentMap[email].totalViolations++;
                });

                // Process Scores/Submissions
                scoreSnap.forEach(doc => {
                    const s = doc.data();
                    const email = s.studentEmail;
                    submissionsMap[email] = doc.id;

                    if (!studentMap[email]) studentMap[email] = { name: s.studentName || "Unknown", email, violations: {}, totalViolations: 0 };

                    studentMap[email].score = s.score !== undefined ? s.score : "-";
                    studentMap[email].status = s.examAccessStatus || "pending";
                    // If name was unknown from violations, try to get from submission
                    if (studentMap[email].name === "Unknown" && s.studentName) studentMap[email].name = s.studentName;
                });

                renderTable(studentMap);
                examDetailsSection.classList.remove("hidden");

            } catch (error) {
                console.error("Error loading data:", error);
                alert("Failed to load exam data.");
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i data-lucide="search" class="w-4 h-4 mr-2"></i> Load Data';
                lucide.createIcons();
            }
        });

        function renderTable(studentMap) {
            if (Object.keys(studentMap).length === 0) {
                tableContainer.innerHTML = '<div class="p-8 text-center text-gray-500">No submissions or violations recorded for this exam yet.</div>';
                return;
            }

            let html = `
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                         <th scope="col" class="px-6 py-3">Student Name</th>
                         <th scope="col" class="px-6 py-3">Email</th>
                         <th scope="col" class="px-6 py-3">Violations Summary</th>
                         <th scope="col" class="px-6 py-3 text-center">Total Incidents</th>
                         <th scope="col" class="px-6 py-3 text-center">Score</th>
                         <th scope="col" class="px-6 py-3 text-right">Action</th>
                    </tr>
                </thead>
                <tbody>`;

            Object.values(studentMap).forEach(s => {
                const vioSummary = Object.entries(s.violations).map(([k, v]) => `<span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded border border-red-400">${v} ${k}</span>`).join(' ');

                const rowId = `row-${s.email.replace(/[^a-zA-Z0-9]/g, '')}`;

                let statusClass = "";
                if (s.status === "approved") statusClass = "bg-green-50";
                else if (s.status === "denied") statusClass = "bg-red-50";

                html += `
                <tr id="${rowId}" class="bg-white border-b hover:bg-gray-50 ${statusClass}">
                    <td class="px-6 py-4 font-medium text-gray-900">${s.name}</td>
                    <td class="px-6 py-4">${s.email}</td>
                    <td class="px-6 py-4">${vioSummary || '<span class="text-green-500">None</span>'}</td>
                    <td class="px-6 py-4 text-center font-bold ${s.totalViolations > 0 ? 'text-red-600' : 'text-green-600'}">${s.totalViolations}</td>
                    <td class="px-6 py-4 text-center font-bold text-gray-900">${s.score}</td>
                    <td class="px-6 py-4 text-right">
                         <button class="bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-200 font-medium rounded-lg text-xs px-3 py-1.5 transition-colors show-modal-btn" data-email="${s.email}">
                            Review & Act
                        </button>
                    </td>
                </tr>`;
            });

            html += `</tbody></table>`;
            tableContainer.innerHTML = html;

            document.querySelectorAll('.show-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    showStudentModal(e.target.dataset.email);
                });
            });
        }


        window.showStudentModal = (email) => {
            const filtered = currentViolations.filter(v => v.studentEmail === email);
            const submissionId = submissionsMap[email];

            // Even if no violations, we might want to approve/deny based on score or just manual review
            // But logic says "Review Violations", so if none, user might just want to see score... 
            // Let's allow opening logic even if empty violations, to manually approve/deny.

            approveBtn.dataset.email = email;
            denyBtn.dataset.email = email;
            approveBtn.dataset.submissionId = submissionId || "";
            denyBtn.dataset.submissionId = submissionId || "";

            // User Info
            // Find name from filtered OR we need the studentMap accessible locally or simply pass it.
            // Simplified: grab from DOM or just use email
            modalTitle.textContent = "Review Student Status";
            modalInfo.textContent = `Student: ${email} | Total Violations: ${filtered.length}`;

            // Table
            let rows = "";
            if (filtered.length === 0) {
                rows = `<tr><td colspan="3" class="px-6 py-4 text-center text-green-600">No violations recorded. Clean record!</td></tr>`;
            } else {
                filtered.forEach(v => {
                    const ts = v.detectedAt ? new Date(v.detectedAt.seconds * 1000).toLocaleString() : (v.timestamp ? new Date(v.timestamp).toLocaleString() : 'N/A');
                    rows += `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-red-600">${v.event || v.type || "Unknown"}</td>
                            <td class="px-6 py-4">${ts}</td>
                            <td class="px-6 py-4">${v.description || '-'}</td>
                        </tr>
                    `;
                });
            }
            modalTable.innerHTML = rows;
            toggleModal(true);
        };

        const toggleModal = (show) => {
            if (show) {
                studentModal.classList.remove('hidden');
                studentModal.classList.add('flex');
            } else {
                studentModal.classList.add('hidden');
                studentModal.classList.remove('flex');
            }
        };

        [closeModalBtn, closeModalBtnFooter].forEach(btn => btn.addEventListener('click', () => toggleModal(false)));


        // Actions
        const updateStatus = async (status) => {
            const email = approveBtn.dataset.email; // both btns have same data
            const submissionId = approveBtn.dataset.submissionId;

            if (!submissionId) {
                alert("No submission record found for this student (they might not have finished the exam). Cannot update status.");
                return;
            }

            try {
                await updateDoc(doc(db, `exams/${currentExamId}/submissions`, submissionId), {
                    examAccessStatus: status
                });

                const rowId = `row-${email.replace(/[^a-zA-Z0-9]/g, '')}`;
                const row = document.getElementById(rowId);
                if (row) {
                    row.classList.remove('bg-green-50', 'bg-red-50');
                    if (status === 'approved') row.classList.add('bg-green-50');
                    if (status === 'denied') row.classList.add('bg-red-50');
                }

                alert(`User ${status.toUpperCase()} successfully.`);
                toggleModal(false);

            } catch (error) {
                console.error("Update error:", error);
                alert("Failed to update status.");
            }
        }

        approveBtn.addEventListener("click", () => updateStatus("approved"));
        denyBtn.addEventListener("click", () => updateStatus("denied"));


        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                window.location.href = "../../index.html";
            }).catch((error) => {
                alert("Error signing out.");
            });
        });

        lucide.createIcons();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>

</html>